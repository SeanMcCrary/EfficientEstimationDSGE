function par = dmp_tpcoef_sym(z,x,par)

% Initial Guess Parameters
a1 = x(1);
a2 = x(2);

% parameters
alfa  = par.alfa;
b     = par.b;
bet   = par.bet;
c     = par.c;
del   = par.del;
eta   = par.eta;
rhoz  = par.rhoz;
egrid = par.egrid;
eprob = par.ewgt;
e1    = egrid(1);
e2    = egrid(2);
e3    = egrid(3);
w1    = eprob(1);
w2    = eprob(2);
w3    = eprob(3);

% Residuals
R  = ((a1 + a2*z)^alfa + 1)^(1/alfa) ...
    + bet*(del - 1)*(w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa)  ...
    +                   w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa)  ...
    +                   w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa)) ...
    - ((b - exp(z))*(eta - 1))/c;

Rz = a2*((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*z)^(alfa - 1) ...
    + bet*(del - 1)*(a2*rhoz*w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 1) ...
    +                   a2*rhoz*w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 1) ...
    +                   a2*rhoz*w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 1)) ...
    + (exp(z)*(eta - 1))/c ;

% Jabobian
J11 = ((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*z)^(alfa - 1) ...
    + bet*(del - 1)*(w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 1) ...
    +                   w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 1) ...
    +                   w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 1));


J12 = bet*(del - 1)*(w1*(e1 + rhoz*z)*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 1) ...
    +                w2*(e2 + rhoz*z)*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 1) ...
    +                w3*(e3 + rhoz*z)*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 1)) ...
    + z*((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*z)^(alfa - 1) ;


J21 = bet*(del - 1)*(a2*rhoz*w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 2) ...
    +                a2*rhoz*w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 2) ...
    +                a2*rhoz*w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 2) ...
    +                a2*alfa*rhoz*w1*(1/alfa - 1)*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e1 + a2*rhoz*z)^(2*alfa - 2) ...
    +                a2*alfa*rhoz*w2*(1/alfa - 1)*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e2 + a2*rhoz*z)^(2*alfa - 2) ...
    +                a2*alfa*rhoz*w3*(1/alfa - 1)*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e3 + a2*rhoz*z)^(2*alfa - 2)) ...
    +                a2*((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*z)^(alfa - 2) ...
    +                a2*alfa*((a1 + a2*z)^alfa + 1)^(1/alfa - 2)*(1/alfa - 1)*(a1 + a2*z)^(2*alfa - 2);

J22 = ((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*z)^(alfa - 1) ...
    + bet*(del - 1)*(rhoz*w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 1) ...
    +                   rhoz*w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 1) ...
    +                   rhoz*w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 1) ...
    +                a2*rhoz*w1*(e1 + rhoz*z)*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 2) ...
    +                a2*rhoz*w2*(e2 + rhoz*z)*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 2) ...
    +                a2*rhoz*w3*(e3 + rhoz*z)*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 2) ...
    +           a2*alfa*rhoz*w1*(e1 + rhoz*z)*(1/alfa - 1)*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e1 + a2*rhoz*z)^(2*alfa - 2) ...
    +           a2*alfa*rhoz*w2*(e2 + rhoz*z)*(1/alfa - 1)*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e2 + a2*rhoz*z)^(2*alfa - 2) ...
    +           a2*alfa*rhoz*w3*(e3 + rhoz*z)*(1/alfa - 1)*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e3 + a2*rhoz*z)^(2*alfa - 2)) ...
    +           a2*z*((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*z)^(alfa - 2) ...
    +           a2*alfa*z*((a1 + a2*z)^alfa + 1)^(1/alfa - 2)*(1/alfa - 1)*(a1 + a2*z)^(2*alfa - 2);


% Newton solver
tol1    = 1;
tol2    = 1;
maxiter = 100;
crit    = 1e-8;
tol     = max(tol1,tol2);
B       = [a1;a2];
count   = 0;

while tol > crit && count<=maxiter

    % Newton solver
    Jac = [J11 J12; J21 J22];
    F   = [R; Rz];

    Bp = B - Jac\F;

    % check convergence
    count = count +1;
    tol1  = norm(F);
    tol2  = norm(abs(Bp-B)./(abs(B)+0.01));
    tol   = max(tol1,tol2);

    % update coefficients
    B  = Bp;
    a1 = B(1);
    a2 = B(2);

    % update residuals
    R  = ((a1 + a2*z)^alfa + 1)^(1/alfa) ...
        + bet*(del - 1)*(w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa)  ...
        +                   w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa)  ...
        +                   w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa)) ...
        - ((b - exp(z))*(eta - 1))/c;

    Rz = a2*((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*z)^(alfa - 1) ...
        + bet*(del - 1)*(a2*rhoz*w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 1) ...
        +                   a2*rhoz*w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 1) ...
        +                   a2*rhoz*w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 1)) ...
        + (exp(z)*(eta - 1))/c ;


    % update jacobian
    J11 = ((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*z)^(alfa - 1) ...
        + bet*(del - 1)*(w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 1) ...
        +                   w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 1) ...
        +                   w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 1));


    J12 = bet*(del - 1)*(w1*(e1 + rhoz*z)*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 1) ...
        +                w2*(e2 + rhoz*z)*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 1) ...
        +                w3*(e3 + rhoz*z)*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 1)) ...
        + z*((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*z)^(alfa - 1) ;


    J21 = bet*(del - 1)*(a2*rhoz*w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 2) ...
        +                a2*rhoz*w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 2) ...
        +                a2*rhoz*w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 2) ...
        +                a2*alfa*rhoz*w1*(1/alfa - 1)*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e1 + a2*rhoz*z)^(2*alfa - 2) ...
        +                a2*alfa*rhoz*w2*(1/alfa - 1)*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e2 + a2*rhoz*z)^(2*alfa - 2) ...
        +                a2*alfa*rhoz*w3*(1/alfa - 1)*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e3 + a2*rhoz*z)^(2*alfa - 2)) ...
        +                a2*((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*z)^(alfa - 2) ...
        +                a2*alfa*((a1 + a2*z)^alfa + 1)^(1/alfa - 2)*(1/alfa - 1)*(a1 + a2*z)^(2*alfa - 2);

    J22 = ((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*z)^(alfa - 1) ...
        + bet*(del - 1)*(rhoz*w1*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 1) ...
        +                   rhoz*w2*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 1) ...
        +                   rhoz*w3*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 1) ...
        +                a2*rhoz*w1*(e1 + rhoz*z)*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e1 + a2*rhoz*z)^(alfa - 2) ...
        +                a2*rhoz*w2*(e2 + rhoz*z)*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e2 + a2*rhoz*z)^(alfa - 2) ...
        +                a2*rhoz*w3*(e3 + rhoz*z)*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*e3 + a2*rhoz*z)^(alfa - 2) ...
        +           a2*alfa*rhoz*w1*(e1 + rhoz*z)*(1/alfa - 1)*((a1 + a2*e1 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e1 + a2*rhoz*z)^(2*alfa - 2) ...
        +           a2*alfa*rhoz*w2*(e2 + rhoz*z)*(1/alfa - 1)*((a1 + a2*e2 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e2 + a2*rhoz*z)^(2*alfa - 2) ...
        +           a2*alfa*rhoz*w3*(e3 + rhoz*z)*(1/alfa - 1)*((a1 + a2*e3 + a2*rhoz*z)^alfa + 1)^(1/alfa - 2)*(a1 + a2*e3 + a2*rhoz*z)^(2*alfa - 2)) ...
        +           a2*z*((a1 + a2*z)^alfa + 1)^(1/alfa - 1)*(alfa - 1)*(a1 + a2*z)^(alfa - 2) ...
        +           a2*alfa*z*((a1 + a2*z)^alfa + 1)^(1/alfa - 2)*(1/alfa - 1)*(a1 + a2*z)^(2*alfa - 2);

end

% Output
par = Bp;

end